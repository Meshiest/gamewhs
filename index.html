<!doctype html>
<html>
  <head>
    <title>Game</title>
    <style>
* {
  margin: 0;
  padding: 0;
  box-sizing:
  border-box;
}
#draw {
  position:absolute;
  width:100%;
  height:100%;
  border:1px solid #000000;
}
    </style>
  </head>
  <body>
    <canvas id="draw">
    </canvas>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>

  var theta = 0;
  var x = 0;
  var y = 0;
  var ship = new Image();
  ship.src = 'ship.png';
  var players = {}


  var keys = {};
  // 87, 65, 83, 68
  keys[87] = keys[65] = keys[83] = keys[68] = false;

  $(document).on('touchstart', function(e) {
      e.preventDefault();
      keys[87] = true;
  });

  $(document).on('touchend', function(e) {
      keys[87] = false;
  });

  
  $('html, body').scrollTop(1);

  if(window.DeviceMotionEvent != undefined) {
    window.ondevicemotion = function(e) {
      var accel = event.accelerationIncludingGravity;
      if(Math.abs(accel.y) > 1) {
        keys[65] = accel.y < 0;
        keys[68] = accel.y > 0;
      } else {
        keys[65] = keys[68] = false;
      }
    }
  }
  
  $(window).on("keydown",function(e){
    keys[e.keyCode] = true;
  });
  $(window).on("keyup",function(e){
    keys[e.keyCode] = false;
  });

  var curr = new Date().getTime();
  var last = curr;
  var canvas = $('#draw')[0];
  var g = canvas.getContext('2d');

  canvas.width = $(window).width();
  canvas.height = $(window).height();

  var socket = io();


  setInterval(function() {
    g.save();
    g.fillStyle="#FFFFFF";
    g.fillRect(0,0,canvas.width,canvas.height);
    last = curr;
    curr = new Date().getTime();
    var delta = (curr - last)/1000.0;

    if(keys[68]) {
      theta += Math.PI*delta;
      while(theta > Math.PI)
        theta -= Math.PI*2;
    } else if(keys[65]) {
      theta -= Math.PI*delta;
      while(theta < -Math.PI)
        theta += Math.PI*2;
    }
    if(keys[87]) {
      x += Math.cos(theta)*delta*300;
      y += Math.sin(theta)*delta*300;
    }
    
    g.translate(canvas.width/2 - x, canvas.height/2 - y);
    drawImage(g, ship, x, y, theta);
    for(var i in players) {
      var player = players[i];
      player.x = player.x + (player.gx - player.x) * 0.3;
      player.y = player.y + (player.gy - player.y) * 0.3;
      player.theta = player.theta + (player.gtheta - player.theta) * 0.3;
      drawImage(g, ship, player.x, player.y, player.theta);
    
    }

    socket.emit('location', x, y, theta);
    g.restore();
  },25);

  socket.on('location', function(id, x, y, theta){
    var player = players[id];
    player.gx = x;
    player.gy = y;
    player.theta = theta;
  });

  socket.on('connection', function(id, x, y, theta) {
   var player = players[id] = {}
   player.gx = x;
   player.gy = y;
   player.gtheta = theta;
   player.x = x
   player.y = y
   player.theta = theta
  });

  socket.on('disconnection', function(id) {
    delete players[id];
  });
  function drawImage(g, img, x, y, theta) {
    g.save();
    g.translate(x, y);
    g.rotate(theta);
    g.drawImage(img, -img.width/2, -img.height/2);
    g.restore();
  }

  </script>
</html>